[gd_scene load_steps=18 format=3 uid="uid://cnew2lxrfa7q7"]

[ext_resource type="PackedScene" uid="uid://b4dyl3ppwa1rc" path="res://moving_entities/enemies/base_enemy/base_enemy.tscn" id="1_gcbln"]
[ext_resource type="Texture2D" uid="uid://by5ilqlhkdeaq" path="res://moving_entities/enemies/bat_small/bat_small.png" id="2_8qtsm"]
[ext_resource type="Resource" uid="uid://ctj0uyr81n57k" path="res://elements/null.tres" id="3_1ls6v"]
[ext_resource type="Script" path="res://moving_entities/enemies/States/idle.gd" id="3_sk0yk"]
[ext_resource type="PackedScene" uid="uid://42pqgoacrk05" path="res://moving_entities/enemies/bosses/boss_bat/b_boss_cone.tscn" id="4_0nrxh"]
[ext_resource type="Script" path="res://moving_entities/enemies/States/attack.gd" id="4_77mgy"]
[ext_resource type="Script" path="res://spells/spell_base.gd" id="5_sn5q4"]
[ext_resource type="PackedScene" uid="uid://c0om0serdslhn" path="res://moving_entities/enemies/bosses/boss_bat/b_bat_dash/b_bat_dash_attack.tscn" id="6_3tphm"]

[sub_resource type="GDScript" id="GDScript_b5sd0"]
script/source = "extends EnemyEntity

var dash_prep_pos: Vector2
"

[sub_resource type="CircleShape2D" id="CircleShape2D_rrw4v"]
radius = 71.0634

[sub_resource type="Resource" id="Resource_sbqj1"]
script = ExtResource("5_sn5q4")
suffix = ""
description = ""
scene = ExtResource("4_0nrxh")
element = ExtResource("3_1ls6v")

[sub_resource type="Resource" id="Resource_3u7ki"]
script = ExtResource("5_sn5q4")
suffix = ""
description = ""
scene = ExtResource("6_3tphm")
element = ExtResource("3_1ls6v")

[sub_resource type="GDScript" id="GDScript_vnb1m"]
resource_name = "Default"
script/source = "extends State
#class_name
#Authored by AlexV. Please consult for any modifications or major feature requests.

#region Variables
@onready var ray_cast_2d = $\"../../RayCast2D\"

@export var cone_attack_range: float = 200

var player: Player
#endregion


#region Signal methods

#endregion

#region Other methods (please try to separate and organise!)
func enter():
	play_anim()
	set_position()

func physics_update(delta):
	super.physics_update(delta)
	if !player: return
	
	#TODO Dash attack check
	if can_cast_spell(1):
		ray_cast_2d.target_position = get_furthest_player().global_position.direction_to(enemy.global_position) * 9999
		ray_cast_2d.force_raycast_update()
		if ray_cast_2d.is_colliding():
			enemy.dash_prep_pos = ray_cast_2d.get_collision_point()
			Transitioned.emit(self, \"dashprep\")
	
	#Cone attack when too close to player
	if enemy.global_position.distance_to(player.global_position) < cone_attack_range && can_cast_spell(0):
		enemy.aim_direction = enemy.global_position.direction_to(player.global_position)
		enemy.target_area = player.global_position
		Transitioned.emit(self, \"coneattack\")
		return
	
	#TODO 50/50 Bomb attack
	
	#TODO Dodge
	
	#TODO Dark Room
	pass


func set_position():
	player = get_closest_player()
	if player: navigation_agent.target_position = player.global_position
	else: Transitioned.emit(self, \"idle\")
#endregion

"

[sub_resource type="GDScript" id="GDScript_ibf6a"]
resource_name = "DashPrep"
script/source = "extends State
#class_name
#Authored by AlexV. Please consult for any modifications or major feature requests.

#region Variables
	#Signals

	#Enums

	#Constants

	#Exported Variables
	#@export_group(\"Group\")
	#@export_subgroup(\"Subgroup\")

	#Onready Variables
@onready var ray_cast_2d = $\"../../RayCast2D\"
	#Other Variables (please try to separate and organise!)

#endregion

#region Godot methods

#endregion

#region Signal methods

#endregion

#region Other methods (please try to separate and organise!)
func enter():
	play_anim()
	set_position()
	
func physics_update(delta):
	super.physics_update(delta)
	if enemy.global_position.distance_to(enemy.dash_prep_pos) < 100:
		enemy.aim_direction = enemy.global_position.direction_to(get_furthest_player().global_position)
		ray_cast_2d.target_position = enemy.aim_direction * 9999
		ray_cast_2d.force_raycast_update()
		if ray_cast_2d.is_colliding():
			enemy.target_area = ray_cast_2d.get_collision_point()
			enemy.aim_direction = enemy.global_position.direction_to(enemy.target_area)
			Transitioned.emit(self, \"dashattack\")
	
func set_position():
	if \"dash_prep_pos\" in enemy && enemy.dash_prep_pos:
		navigation_agent.target_position = enemy.dash_prep_pos
	else: Transitioned.emit(self, \"default\")
#endregion

"

[sub_resource type="CircleShape2D" id="CircleShape2D_f8rpe"]
radius = 14.1421

[sub_resource type="Animation" id="Animation_w55vx"]
resource_name = "idle"

[sub_resource type="AnimationLibrary" id="AnimationLibrary_dckjw"]
_data = {
"idle": SubResource("Animation_w55vx")
}

[node name="BossBat" instance=ExtResource("1_gcbln")]
collision_mask = 1
script = SubResource("GDScript_b5sd0")
death_sound = null

[node name="Sprite2D" parent="." index="1"]
position = Vector2(0, -49)
texture = ExtResource("2_8qtsm")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Hurtbox" index="0"]
position = Vector2(0, 13)
shape = SubResource("CircleShape2D_rrw4v")
debug_color = Color(0.956863, 0, 0.533333, 0.137255)

[node name="ProgressBar" parent="." index="3"]
offset_top = -77.0
offset_bottom = -70.0

[node name="StatusUI" parent="." index="4"]
offset_top = -111.0
offset_bottom = -79.0

[node name="EnemySpells" parent="." index="5"]
spells = Array[ExtResource("5_sn5q4")]([SubResource("Resource_sbqj1"), SubResource("Resource_3u7ki")])
cast_time = Array[float]([1.0, 0.2, 0.2])

[node name="StateMachine" parent="." index="6" node_paths=PackedStringArray("initial_state")]
initial_state = NodePath("Idle")

[node name="Idle" type="Node" parent="StateMachine" index="0" node_paths=PackedStringArray("actual_first_state")]
script = ExtResource("3_sk0yk")
actual_first_state = NodePath("../Default")

[node name="Default" type="Node" parent="StateMachine" index="1"]
script = SubResource("GDScript_vnb1m")

[node name="ConeAttack" type="Node" parent="StateMachine" index="2"]
script = ExtResource("4_77mgy")
transition_out_when_can_cast = true
nav_timer_interval = 99.0

[node name="DashPrep" type="Node" parent="StateMachine" index="3"]
script = SubResource("GDScript_ibf6a")

[node name="DashAttack" type="Node" parent="StateMachine" index="4"]
script = ExtResource("4_77mgy")
spell_num = 1
transition_out_when_can_cast = true
next_state = "default"
nav_timer_interval = 99.0
nav_timer = 99

[node name="HitSound" parent="." index="10"]
visible = false

[node name="CollisionShape2D" type="CollisionShape2D" parent="." index="11"]
position = Vector2(-1, -21)
shape = SubResource("CircleShape2D_f8rpe")

[node name="AnimationPlayer" type="AnimationPlayer" parent="." index="12"]
libraries = {
"": SubResource("AnimationLibrary_dckjw")
}

[node name="RayCast2D" type="RayCast2D" parent="." index="13"]
