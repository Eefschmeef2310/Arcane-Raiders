[gd_scene load_steps=11 format=3 uid="uid://c5fgoh06xrvsb"]

[ext_resource type="PackedScene" uid="uid://bp3p5hgbn2t6t" path="res://moving_entities/player/player.tscn" id="1_a4rya"]
[ext_resource type="Script" path="res://moving_entities/enemies/States/state_machine.gd" id="2_r37mn"]
[ext_resource type="Script" path="res://moving_entities/enemies/States/idle.gd" id="3_58eft"]
[ext_resource type="PackedScene" uid="uid://fpqy0jpm8ydv" path="res://moving_entities/health_bar.tscn" id="4_jwyjq"]

[sub_resource type="GDScript" id="GDScript_71bfm"]
resource_name = "EvilWizard"
script/source = "extends Player
#class_name
#Authored by AlexV. Please consult for any modifications or major feature requests.

#region Variables
signal wizard_hurt
signal wizard_died(wizard: Node)

@onready var nav_agent = $NavigationAgent2D

@export var wizard_dash_cooldown: float = 1
@export var wizard_dash_cooldown_max: float = 10

var spell_position: Vector2 = Vector2.ZERO

#endregion

#region Godot methods
func _ready():
	super._ready()
	$Input.start_state_machine(nav_agent)

#endregion

#region Signal methods

#Physcis Process

func _physics_process(delta):
	nav_agent.set_velocity(global_position.direction_to(nav_agent.get_next_path_position()))
	super._physics_process(delta)
	wizard_dash_cooldown -= delta
#endregion

#region Other methods (please try to separate and organise!)

#endregion

func on_hurt(attack):
	super.on_hurt(attack)
	wizard_hurt.emit()

func _on_zero_health():
	wizard_died.emit()
	call_deferred(\"queue_free\")

#Set move direction to direction of safe velocity
func _on_navigation_agent_2d_velocity_computed(safe_velocity: Vector2):
	move_direction = safe_velocity.normalized()
"

[sub_resource type="GDScript" id="GDScript_sd0g0"]
resource_name = "wizard_walk"
script/source = "extends State
#class_name
#Authored by AlexV. Please consult for any modifications or major feature requests.

#region Variables

#endregion

#region Godot methods

#endregion

#region Signal methods

#TODO when a player spell enters the collision field, call this signal if it is the current state
func _spell_entered(area):
	if get_parent().current_state.name.to_lower() == name.to_lower() && owner.wizard_dash_cooldown <= 0 && is_multiplayer_authority():
		owner.spell_position = area.global_position
		Transitioned.emit(self, \"dashing\")
#endregion

#region Other methods (please try to separate and organise!)
func physics_update(delta):
	super.physics_update(delta)
	
	
	#Check spell cooldowns to cast spells :D

func set_position():
	navigation_agent.target_position = get_closest_player().global_position
#endregion

"

[sub_resource type="GDScript" id="GDScript_oflwe"]
resource_name = "wizard_dash_state"
script/source = "extends State
#class_name
#Authored by AlexV. Please consult for any modifications or major feature requests.

#region Godot methods

#endregion

#region Signal methods

#endregion

#region Other methods (please try to separate and organise!)
func enter():
	if is_multiplayer_authority():
		owner.aim_direction = owner.global_position.direction_to(owner.spell_position).rotated(deg_to_rad(90))
		owner.move_direction = owner.aim_direction
		owner.wizard_dash_cooldown = owner.wizard_dash_cooldown_max
		owner.attempt_dash()

func physics_update(delta):
	super.physics_update(delta)
	if !owner.is_dashing:
		Transitioned.emit(self, \"default\")
#endregion

"

[sub_resource type="AudioStreamRandomizer" id="AudioStreamRandomizer_onr5v"]
resource_local_to_scene = true
random_pitch = 1.1
streams_count = 1
stream_0/weight = 1.0

[sub_resource type="Gradient" id="Gradient_cmhpy"]
resource_local_to_scene = true
offsets = PackedFloat32Array(0, 0.546053)
colors = PackedColorArray(0, 0, 0, 0, 0, 0, 0, 1)

[sub_resource type="CircleShape2D" id="CircleShape2D_spcxr"]
radius = 372.012

[node name="EvilWizard" groups=["enemy"] instance=ExtResource("1_a4rya")]
collision_layer = 8
script = SubResource("GDScript_71bfm")
wizard_dash_cooldown = 1.0
wizard_dash_cooldown_max = 10.0
debug = false
movement_speed = 300.0
death_sound = null
do_damage_numbers = true

[node name="Sprite2DShadow" parent="SpellDirection" index="0"]
visible = false

[node name="Sprite2D" parent="SpellDirection" index="1"]
visible = false

[node name="Input" parent="." index="3" node_paths=PackedStringArray("initial_state", "debug_label")]
script = ExtResource("2_r37mn")
initial_state = NodePath("Idle")
debug_label = NodePath("../Label")

[node name="Idle" type="Node" parent="Input" index="0" node_paths=PackedStringArray("actual_first_state")]
script = ExtResource("3_58eft")
actual_first_state = NodePath("../Default")

[node name="Default" type="Node" parent="Input" index="1"]
script = SubResource("GDScript_sd0g0")

[node name="Dashing" type="Node" parent="Input" index="2"]
script = SubResource("GDScript_oflwe")

[node name="Hurtbox" parent="." index="7"]
collision_mask = 272

[node name="Body" parent="SpritesFlip/SpritesScale" index="0"]
self_modulate = Color(0.305882, 0.0901961, 0, 1)

[node name="MultiplayerSynchronizer" parent="." index="12" groups=["boss", "enemy"]]

[node name="DashBar" parent="." index="15"]
script = null

[node name="StatusUI" parent="." index="16"]
offset_top = -148.0
offset_bottom = -116.0

[node name="Label" type="Label" parent="." index="17"]
offset_left = 77.0
offset_top = -62.0
offset_right = 117.0
offset_bottom = -37.6667

[node name="ProgressBar" parent="." index="18" instance=ExtResource("4_jwyjq")]
offset_top = -112.0
offset_bottom = -108.0

[node name="AnimalSound" parent="." index="24"]
stream = SubResource("AudioStreamRandomizer_onr5v")

[node name="DashTrail" parent="." index="26"]
gradient = SubResource("Gradient_cmhpy")

[node name="NavigationAgent2D" type="NavigationAgent2D" parent="." index="28"]
path_postprocessing = 1
avoidance_enabled = true
radius = 25.0
max_speed = 1000.0
avoidance_priority = 0.1

[node name="DashDetector" type="Area2D" parent="." index="30"]
collision_layer = 0
collision_mask = 16

[node name="CollisionShape2D" type="CollisionShape2D" parent="DashDetector" index="0"]
position = Vector2(5, -29)
shape = SubResource("CircleShape2D_spcxr")
debug_color = Color(0, 0.6, 0.701961, 0.0745098)

[connection signal="health_updated" from="." to="ProgressBar" method="_on_enemy_health_updated"]
[connection signal="zero_health" from="." to="." method="_on_zero_health"]
[connection signal="velocity_computed" from="NavigationAgent2D" to="." method="_on_navigation_agent_2d_velocity_computed"]
[connection signal="area_entered" from="DashDetector" to="Input/Default" method="_spell_entered"]
